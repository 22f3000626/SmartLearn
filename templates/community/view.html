<!-- view_community.html - Modern Community View Page -->
{% extends 'base.html' %}
{% block title %}{{ community.name }} - SmartLearn{% endblock %}
{% block content %}
<div class="container py-4">
    {% if community_created_success %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <i class="fas fa-check-circle me-2"></i>
            Welcome to your new community! Start engaging with your first post.
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endif %}

    <!-- Community Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex align-items-center mb-3">
                                <div class="community-avatar me-3">
                                    <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                         style="width: 60px; height: 60px; font-size: 1.8rem;">
                                        {{ community.name[0].upper() }}
                                    </div>
                                </div>
                                <div>
                                    <h1 class="mb-1">{{ community.name }}</h1>
                                    <p class="text-muted mb-0">{{ community.description }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if not is_member %}
                                <a href="{{ url_for('community_routes.join_community', community_id=community.id) }}" 
                                   class="btn btn-primary btn-lg">
                                    <i class="fas fa-user-plus me-2"></i>Join Community
                                </a>
                                <p class="small text-muted mt-2">
                                    <i class="fas fa-lock me-1"></i>You must join to participate
                                </p>
                            {% else %}
                                <div class="dropdown">
                                    <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-check me-2"></i>Joined
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item text-danger" 
                                               href="{{ url_for('community_routes.leave_community', community_id=community.id) }}">
                                                <i class="fas fa-sign-out-alt me-2"></i>Leave Community
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            {% if is_member %}
            <!-- Post Creation -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="fas fa-pen me-2"></i>Share Something
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('community_routes.post_to_community', community_id=community.id) }}" 
                          enctype="multipart/form-data">
                        <div class="mb-3">
                            <textarea name="content" class="form-control" rows="4" 
                                      placeholder="What's on your mind? Share knowledge, ask questions, or start a discussion..." 
                                      required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <input type="file" name="image" class="form-control" accept="image/*">
                                <div class="form-text">
                                    <i class="fas fa-image me-1"></i>Add an image to your post (optional)
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i>Post
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            <!-- Posts Section -->
            <div class="posts-container">
                <h4 class="mb-4">
                    <i class="fas fa-comments me-2"></i>Community Posts
                    <span class="badge bg-primary ms-2">{{ posts|length }}</span>
                </h4>

                {% for post in posts %}
                <div class="card border-0 shadow-sm mb-4 post-card" id="post-{{ post.id }}">
                    <!-- Post Image -->
                    {% if post.image_path and post.image_path.split('.')[-1]|lower in ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'] %}
                        <img src="{{ url_for('static', filename=post.image_path) }}" alt="Post Image" class="card-img-top">
                    {% endif %}
                    <div class="card-body p-4">
                        <!-- Post Header -->
                        <div class="d-flex align-items-center mb-3">
                            <img src="{{ url_for('static', filename=post.author.profile_pic or 'default_profile.png') }}" 
                                 class="rounded-circle me-3" width="45" height="45" alt="Profile">
                            <div class="flex-grow-1">
                                <h6 class="mb-0">
                                    <a href="{{ url_for('community_routes.user_profile', user_id=post.author.id) }}" 
                                       class="text-decoration-none fw-semibold">
                                        {{ post.author.username }}
                                    </a>
                                </h6>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    {{ post.timestamp.strftime('%B %d, %Y at %I:%M %p') }}
                                </small>
                            </div>
                        </div>

                        <!-- Post Content -->
                        <div class="post-content mb-3">
                            <p class="mb-0">{{ post.content }}</p>
                        </div>
                        
                        <!-- File Attachment Link -->
                        {% if post.image_path and post.image_path.split('.')[-1]|lower not in ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'] %}
                        <div class="mb-3 p-2 border rounded bg-light">
                            <i class="fas fa-file-alt me-2"></i>
                            <a href="{{ url_for('static', filename=post.image_path) }}" target="_blank" rel="noopener noreferrer">
                                {{ post.image_path.split('/')[-1] }}
                            </a>
                        </div>
                        {% endif %}

                        <!-- Post Actions -->
                        <div class="post-actions d-flex align-items-center">
                            <form method="POST" action="{{ url_for('community_routes.like_post', post_id=post.id) }}" class="me-2">
                                <button type="submit" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-thumbs-up me-1"></i>Like ({{ post.like_count }})
                                </button>
                            </form>
                            <button type="button" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="collapse" data-bs-target="#reply-form-{{ post.id }}">
                                <i class="fas fa-reply me-1"></i>Reply
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm share-btn" data-bs-toggle="modal" data-bs-target="#shareModal" data-post-url="{{ url_for('community_routes.view_community', community_id=post.community_id, _anchor='post-' ~ post.id, _external=True) }}">
                                <i class="fas fa-share me-1"></i>Share
                            </button>
                        </div>

                        <!-- Reply Form -->
                        <div class="collapse mt-3" id="reply-form-{{ post.id }}">
                            <form method="POST" action="{{ url_for('community_routes.add_comment', post_id=post.id) }}">
                                <div class="d-flex">
                                    <input type="text" name="content" class="form-control form-control-sm me-2" placeholder="Write a reply..." required>
                                    <button type="submit" class="btn btn-primary btn-sm">Submit</button>
                                </div>
                            </form>
                        </div>

                        <!-- Comments Section -->
                        <div class="comments-section mt-4">
                            {% for comment in post.comments|sort(attribute='timestamp', reverse=True) %}
                            <div class="d-flex mb-3">
                                <img src="{{ url_for('static', filename=comment.author.profile_pic or 'default_profile.png') }}" class="rounded-circle me-2" width="30" height="30">
                                <div class="bg-light p-2 rounded w-100">
                                    <strong>{{ comment.author.username }}</strong>
                                    <p class="mb-0 small">{{ comment.content }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-comments text-muted mb-3" style="font-size: 4rem;"></i>
                    <h4 class="text-muted">No posts yet</h4>
                    <p class="text-muted">
                        {% if is_member %}
                            Be the first to share something with this community!
                        {% else %}
                            Join the community to see and participate in discussions.
                        {% endif %}
                    </p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Community Stats -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Community Stats
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="text-primary mb-0">{{ posts|length }}</h4>
                                <small class="text-muted">Posts</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-item">
                                <h4 class="text-success mb-0">{{ community.member_count or 0 }}</h4>
                                <small class="text-muted">Members</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('community_routes.list_communities') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-arrow-left me-2"></i>Back to Communities
                        </a>
                        {% if is_member %}
                        <a href="{{ url_for('community_routes.my_communities') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-user me-2"></i>My Communities
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.post-card {
    transition: all 0.3s ease;
}

.post-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.1) !important;
}

.stat-item {
    padding: 1rem 0;
}
</style>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="shareModalLabel">Share Post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Copy the link below to share this post:</p>
                <div class="input-group">
                    <input type="text" id="shareLinkInput" class="form-control" value="" readonly>
                    <button class="btn btn-primary" id="copyLinkBtn">
                        <i class="fas fa-copy me-1"></i>Copy
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
const shareModal = document.getElementById('shareModal');
const shareLinkInput = document.getElementById('shareLinkInput');
const copyLinkBtn = document.getElementById('copyLinkBtn');

shareModal.addEventListener('show.bs.modal', event => {
    // Button that triggered the modal
    const button = event.relatedTarget;
    // Extract info from data-bs-* attributes
    const postUrl = button.getAttribute('data-post-url');
    // Update the modal's content.
    shareLinkInput.value = postUrl;
});

copyLinkBtn.addEventListener('click', () => {
    shareLinkInput.select();
    navigator.clipboard.writeText(shareLinkInput.value).then(() => {
        const originalText = copyLinkBtn.innerHTML;
        copyLinkBtn.innerHTML = '<i class="fas fa-check me-1"></i>Copied!';
        setTimeout(() => {
            copyLinkBtn.innerHTML = originalText;
        }, 2000);
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
});
</script>
{% endblock %}
{% endblock %}